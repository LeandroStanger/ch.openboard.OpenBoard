From 47f0e6bcfb45708db279b3fb4e02179d3677c5e9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Jonah=20Br=C3=BCchert?= <jbb.prv@gmx.de>
Date: Wed, 10 Apr 2019 21:47:07 +0200
Subject: [PATCH 10/10] Linux: Only use onboard by default if it's installed

---
 resources/etc/OpenBoard.config |  1 -
 src/core/UBSettings.cpp        | 16 +++++++++++++++-
 src/core/UBSettings.h          |  1 +
 3 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/resources/etc/OpenBoard.config b/resources/etc/OpenBoard.config
index 1f84f8bb..556ed207 100644
--- a/resources/etc/OpenBoard.config
+++ b/resources/etc/OpenBoard.config
@@ -22,7 +22,6 @@ ToolBarOrientationVertical=false
 ToolBarPositionedAtTop=true
 TutorialUrl=http://www.openboard.ch
 UseMultiscreenMode=true
-UseSystemOnScreenKeyboard=true
 
 [Board]
 AutoSaveIntervalInMinutes=3
diff --git a/src/core/UBSettings.cpp b/src/core/UBSettings.cpp
index 75a81422..fe09209b 100644
--- a/src/core/UBSettings.cpp
+++ b/src/core/UBSettings.cpp
@@ -225,6 +225,20 @@ void UBSettings::ValidateKeyboardPaletteKeyBtnSize()
     boardKeyboardPaletteKeyBtnSize->set(supportedKeyboardSizes->at(0));
 }
 
+bool UBSettings::checkSystemOnScreenKeyboardAvailable()
+{
+#ifdef Q_OS_UNIX
+    QProcess oskTestProcess;
+    oskTestProcess.start("which", QStringList() << "onboard");
+
+    return oskTestProcess.waitForFinished() &&
+                    oskTestProcess.exitStatus() == QProcess::NormalExit &&
+                    oskTestProcess.readAll() != "";
+#else
+    return true;
+#endif
+}
+
 void UBSettings::init()
 {
     productWebUrl =  new UBSetting(this, "App", "ProductWebAddress", "http://www.openboard.ch");
@@ -456,7 +470,7 @@ void UBSettings::init()
 
     libIconSize = new UBSetting(this, "Library", "LibIconSize", defaultLibraryIconSize);
 
-    useSystemOnScreenKeyboard = new UBSetting(this, "App", "UseSystemOnScreenKeyboard", true);
+    useSystemOnScreenKeyboard = new UBSetting(this, "App", "UseSystemOnScreenKeyboard", checkSystemOnScreenKeyboardAvailable());
 
     cleanNonPersistentSettings();
     checkNewSettings();
diff --git a/src/core/UBSettings.h b/src/core/UBSettings.h
index 26cfac49..cf276d6b 100644
--- a/src/core/UBSettings.h
+++ b/src/core/UBSettings.h
@@ -52,6 +52,7 @@ class UBSettings : public QObject
         UBSettings(QObject *parent = 0);
         virtual ~UBSettings();
         void cleanNonPersistentSettings();
+        bool checkSystemOnScreenKeyboardAvailable();
 
     public:
 
-- 
2.20.1

